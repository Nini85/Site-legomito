<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FLL ‚Äî Testador de Sa√≠das (2:30)</title>

  <!-- Bibliotecas externas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Estilos principais -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f5;
      margin: 0;
      padding: 0;
    }

    header {
      background: #004aad;
      color: #fff;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    header h1 {
      margin: 5px 0 0 0;
      font-size: 20px;
    }

    #time {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      right: 20px;
      top: 20px;
    }

    header img.logo {
      width: 165px;
      height: auto;
      position: absolute;
      top: -9px;
      left: 10px;
    }

    main {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      gap: 20px;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      flex: 1;
      min-width: 300px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    h2 { margin-top: 0; }

    .controls button {
      margin: 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .controls button:disabled {
      background: #ddd;
      cursor: not-allowed;
    }

    .primary { background: #004aad; color: white; }
    .warn { background: #f59e0b; color: white; }
    .good { background: #22c55e; color: white; }
    .bad { background: #ef4444; color: white; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }

    .footer {
      text-align: center;
      padding: 15px;
      background: #004aad;
    }

    .footer button {
      background: #22c55e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    /* Tapete e preview */
    .tapete-container { position: relative; display: inline-block; }
    .tapete { max-width: 100%; border-radius: 8px; }
    .ponto {
      position: absolute;
      width: 40px;
      height: 40px;
      cursor: pointer;
      background: rgba(255, 73, 2, 0.2);
      border-radius: 50%;
    }

    .preview {
      display: inline-block;
      margin-left: 20px;
      vertical-align: top;
      text-align: center;
    }

    .preview img {
      display: block;
      margin-bottom: 10px;
      max-width: 300px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.4);
      font-style: italic;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header>
    <img src="4bcb0252-adf8-46d7-989b-a4bcdd070cc1.png" alt="Logo" class="logo">
    <h1>FLL ‚Äî Testador de Sa√≠das (2:30)</h1>
    <div id="time">02:30</div>
  </header>

  <main>
    <!-- Controle -->
    <section class="card">
      <h2>Controle</h2>
      <div class="controls">
        <button class="primary" id="startBtn">Iniciar</button>
        <button id="pauseBtn" disabled>Pausar</button>
        <button class="warn" id="resetBtn">Reiniciar</button>
        <button id="clearTableBtn">Limpar Tabela</button>
        <button id="pdfBtn">Salvar PDF</button>
      </div>
      <h3>Registrar Miss√£o</h3>
      <input id="missionName" placeholder="Nome da Miss√£o" />
      <button class="good" id="successBtn" disabled>Sucesso</button>
      <button class="bad" id="failBtn" disabled>Falha</button>
    </section>

    <!-- Tabelas -->
    <section class="card">
      <h2>Tabelas de Tentativas</h2>
      <label>Filtrar miss√£o espec√≠fica: <input id="filterMission" placeholder="Digite miss√£o" /></label>
      <h3>Miss√£o espec√≠fica</h3>
      <table>
        <thead>
          <tr><th>#</th><th>Miss√£o</th><th>Tempo Decorrido</th><th>Resultado</th></tr>
        </thead>
        <tbody id="specificLog"></tbody>
      </table>

      <h3>Todas as tentativas do dia</h3>
      <table>
        <thead>
          <tr><th>#</th><th>Miss√£o</th><th>Tempo Decorrido</th><th>Resultado</th></tr>
        </thead>
        <tbody id="allLog"></tbody>
      </table>
    </section>

    <!-- Gr√°fico -->
    <section class="card">
      <h2>Gr√°fico</h2>
      <canvas id="durationChart"></canvas>
    </section>
  </main>

  <div class="footer">
    <button onclick="window.open('https://eventhub.firstinspires.org/scoresheet')">Acessar Link</button>
  </div>

  <div class="watermark">‚öôÔ∏è Teste criado pela equipe LegoMito em 2025 üöÄ</div>

  <!-- Scripts -->
  <script>
    // Timer e tentativas
    const SESSION_SECONDS = 150;
    let remaining = SESSION_SECONDS;
    let timerId = null;
    let running = false;
    let attemptActive = false;
    let attempts = [];

    const timeEl = document.getElementById('time');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const clearTableBtn = document.getElementById('clearTableBtn');
    const missionNameEl = document.getElementById('missionName');
    const successBtn = document.getElementById('successBtn');
    const failBtn = document.getElementById('failBtn');
    const logBodyAll = document.getElementById('allLog');
    const logBodySpecific = document.getElementById('specificLog');
    const filterMission = document.getElementById('filterMission');
    const pdfBtn = document.getElementById('pdfBtn');

    function pad(n){ return String(n).padStart(2,'0'); }
    function fmtTime(sec){ const m=Math.floor(sec/60), s=sec%60; return `${pad(m)}:${pad(s)}`; }
    function setTimerUI(){ timeEl.textContent = fmtTime(remaining); }

    function tick(){
      if(!running) return;
      remaining = Math.max(0, remaining-1);
      setTimerUI();
      if(remaining === 0){ stopSession(); alert('Tempo esgotado!'); }
    }

    function startSession(){
      if(running) return;
      running = true;
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      timerId = setInterval(tick, 1000);
      startAttempt();
    }

    function pauseSession(){
      running = false;
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      clearInterval(timerId);
    }

    function stopSession(){ pauseSession(); }

    function resetSession(){
      stopSession();
      remaining = SESSION_SECONDS;
      setTimerUI();
      attemptActive = false;
      successBtn.disabled = true;
      failBtn.disabled = true;
    }

    function clearTables(){
      attempts = [];
      renderTables();
    }

    function startAttempt(){
      if(attemptActive) return;
      attemptActive = true;
      successBtn.disabled = false;
      failBtn.disabled = false;
    }

    function finishAttempt(result){
      if(!attemptActive) return;
      const duration = (SESSION_SECONDS - remaining).toFixed(1);
      attempts.push({mission: missionNameEl.value || "Miss√£o", duration, result});
      renderTables();
      attemptActive = false;
      successBtn.disabled = true;
      failBtn.disabled = true;
      if(remaining > 0) startAttempt();
    }

    function renderTables(){
      logBodyAll.innerHTML = '';
      attempts.forEach((a,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${a.mission}</td><td>${a.duration}s</td><td>${a.result}</td>`;
        logBodyAll.appendChild(tr);
      });

      const filter = filterMission.value.trim().toLowerCase();
      logBodySpecific.innerHTML = '';
      attempts.filter(a => a.mission.toLowerCase().includes(filter)).forEach((a,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${a.mission}</td><td>${a.duration}s</td><td>${a.result}</td>`;
        logBodySpecific.appendChild(tr);
      });

      updateChart();
    }

    filterMission.addEventListener('input', renderTables);

    // Chart
    let durationChart = new Chart(document.getElementById('durationChart'), {
      type: 'bar',
      data: {labels: [], datasets: [{label:'Tempo Decorrido (s)', data: [], backgroundColor:'#004aad'}]},
      options: {scales:{y:{beginAtZero:true}}}
    });

    function updateChart(){
      durationChart.data.labels = attempts.map((_, i) => `Tentativa ${i+1}`);
      durationChart.data.datasets[0].data = attempts.map(a => a.duration);
      durationChart.update();
    }

    // PDF
    async function savePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Relat√≥rio de Tentativas - FLL", 10, 20);
      let y = 30;
      attempts.forEach((a,i) => {
        doc.text(`${i+1}. ${a.mission} - ${a.duration}s - ${a.result}`, 10, y);
        y += 10;
      });
      const canvas = document.getElementById('durationChart');
      const imgData = canvas.toDataURL("image/png",1.0);
      doc.addImage(imgData,'PNG',10,y,180,80);
      doc.save("relatorio_fll.pdf");
    }

    // Event Listeners
    startBtn.onclick = startSession;
    pauseBtn.onclick = pauseSession;
    resetBtn.onclick = resetSession;
    clearTableBtn.onclick = clearTables;
    successBtn.onclick = () => finishAttempt('Sucesso');
    failBtn.onclick = () => finishAttempt('Falha');
    timeEl.onclick = startSession;
    pdfBtn.onclick = savePDF;

    setTimerUI();
  </script>
</body>
</html>
